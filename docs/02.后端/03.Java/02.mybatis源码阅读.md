---
title: mybatisæºç é˜…è¯»
date: 2023-03-08 17:29:07
permalink: /pages/4d5b7f/
comment: true
author: 
  name: wuxin0011
  link: https://github.com/wuxin0011
categories: 
  - Java
  - éšç¬”
tags: 
  - mybatis
---


::: tip
æ”¾æœ¬åœ°æ–‡ä»¶å¤¹éƒ½å¿«åƒåœŸäº†ï¼Œå‡†å¤‡æ¸…ç†æ–‡ä»¶å¤¹ï¼Œå‘ç°è¿˜æœ‰ç¬”è®°ä¸Šä¼ ä¸‹å§ï¼å…³äº`mybatis`çš„
:::

<!-- more -->

## ä¸€ ã€åˆå§‹åŒ–ç¯å¢ƒ



 ä¸­æ–‡ç½‘ ï¼šhttps://mybatis.net.cn



å‰æ

- mavenç¯å¢ƒ
- jdk1.8
- mysql8.0

**pom.xml**

```xml
    <dependencies>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>

        <!-- https://mvnrepository.com/artifact/org.mybatis/mybatis -->
        <dependency>
            <groupId>org.mybatis</groupId>
            <artifactId>mybatis</artifactId>
            <version>3.5.11</version>
        </dependency>

        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!-- https://mvnrepository.com/artifact/junit/junit -->
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.13.2</version>
            <scope>test</scope>
        </dependency>
    </dependencies>



```



**UserMapper.xml**

```XML
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wuxin.mybatis.read.mapper.UserMapper">
    <insert id="addUser" parameterType="java.lang.String">
        insert into `user` (`username`, `address`)
        values (#{username}, #{address})
    </insert>
    <update id="updateId" >
        update `user` set `username`=#{username} ,address=#{address} where userId=#{userId}
    </update>
    <select id="selectOne" resultType="com.wuxin.mybatis.read.pojo.User" parameterType="java.lang.Long">
        select *
        from user
        where userId = #{userId}
    </select>
    <select id="list" resultType="com.wuxin.mybatis.read.pojo.User">
        select * from user;
    </select>
</mapper>
```





**mybatis-config.xml**

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <environments default="development">
        <environment id="development">
            <transactionManager type="JDBC"/>
            <dataSource type="POOLED">
                <property name="driver" value="com.mysql.cj.jdbc.Driver"/>
                <property name="url"
                          value="jdbc:mysql://localhost:3306/mybatis-test?serverTimezone=UTC&amp;character=utf8&amp;useSSL=true"/>
                <property name="username" value="root"/>
                <property name="password" value="123456"/>
            </dataSource>
        </environment>
    </environments>
    <mappers>
        <mapper resource="mappers/UserMapper.xml"/>
    </mappers>
</configuration>
```







## äºŒã€æ‰§è¡Œæµç¨‹

### 1ã€é…ç½®ç¯å¢ƒåˆå§‹åŒ–

// main

```java
// ...
String resource = "mybatis-config.xml";
        InputStream inputStream = Resources.getResourceAsStream(resource);
        SqlSessionFactory sqlSessionFactory = new   SqlSessionFactoryBuilder().build(inputStream);
// ...
```





é€šè¿‡  `org.apache.ibatis.builder.XMLConfigBuilder` ç±»åˆå§‹åŒ–ç¯å¢ƒï¼Œè§£æ xxx.xmlæ–‡ä»¶ç”Ÿæˆå¯¹åº”Javaå¯¹è±¡

```java
    // org.apache.ibatis.builder.XMLConfigBuilder
 private XMLConfigBuilder(XPathParser parser, String environment, Properties props) {
        super(new Configuration());
        // ...
        this.parser = parser;
    }

    // é…ç½®æ–‡ä»¶è§£æåªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹æ¬¡è°ƒç”¨æŠ›å‡ºå¼‚å¸¸ï¼ï¼ï¼
    public Configuration parse() {
        if (this.parsed) {
            throw new BuilderException("Each XMLConfigBuilder can only be used once.");
        } else {
            this.parsed = true;
            this.parseConfiguration(this.parser.evalNode("/configuration"));
            return this.configuration;
        }
    }

   // è¯¥æ–¹æ³•é€šè¿‡
    private void parseConfiguration(XNode root) {
        try {
            this.propertiesElement(root.evalNode("properties"));
            Properties settings = this.settingsAsProperties(root.evalNode("settings"));
            this.loadCustomVfs(settings);
            this.loadCustomLogImpl(settings);
            this.typeAliasesElement(root.evalNode("typeAliases"));
            this.pluginElement(root.evalNode("plugins"));
            this.objectFactoryElement(root.evalNode("objectFactory"));
            this.objectWrapperFactoryElement(root.evalNode("objectWrapperFactory"));
            this.reflectorFactoryElement(root.evalNode("reflectorFactory"));
            this.settingsElement(settings);
            this.environmentsElement(root.evalNode("environments"));
            this.databaseIdProviderElement(root.evalNode("databaseIdProvider"));
            this.typeHandlerElement(root.evalNode("typeHandlers"));
            this.mapperElement(root.evalNode("mappers"));
        } catch (Exception var3) {
            throw new BuilderException("Error parsing SQL Mapper Configuration. Cause: " + var3, var3);
        }
    }
// é€šè¿‡ä¸Šé¢èŠ‚ç‚¹è§£æé¡ºåºçŸ¥é“ï¼ŒèŠ‚ç‚¹ä½ç½®é¡ºåºä¸èƒ½ä¹±ï¼Œæœ€å¥½å‚è€ƒä¸Šé¢è¿™ä¸ªé…ç½®çš„èŠ‚ç‚¹é¡ºåº
```





ç”± `SqlSessionFactoryBuilder` è°ƒç”¨ ` XMLConfigBuilder` çš„ parse æ–¹æ³•ï¼Œè§£æç”Ÿæˆ config å¯¹è±¡é…ç½®

```java
  //   org.apache.ibatis.session.SqlSessionFactoryBuilder build();
  // ...
  XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties);
  var5 = this.build(parser.parse());
```





 `Configuration` ï¼Œåªæœ‰ä¸¤ä¸ªæ„é€ å™¨

```java
   // æœ‰å‚æ„é€ 
   public Configuration(Environment environment) {
        this();
        // å¯ä»¥é€šè¿‡xmlé…ç½®æŒ‡å®šç¯å¢ƒ 
        this.environment = environment;
    }

   // æ— å‚æ„é€ 
   // é»˜è®¤åˆå§‹åŒ–ç¯å¢ƒ é€šè¿‡xmlé…ç½®è¯»å–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šå¯¹åº”é…ç½®ï¼Œé‡‡ç”¨å¦‚ä¸‹é»˜è®¤é…ç½®
   // å…³äºä¸‹é¢é…ç½®è¯¦æƒ…å‚è€ƒ https://mybatis.net.cn/configuration.html
    public Configuration() {
        // åˆå§‹åŒ–å€¼
        // ... è¯¦ç»†é…ç½®å‚è€ƒ org.apache.ibatis.session.Configuration ç±»çš„æ„é€ å‡½æ•°
        this.typeAliasRegistry.registerAlias("SLF4J", Slf4jImpl.class);
        // ... é»˜è®¤é…ç½®æ–‡ä»¶
        this.typeAliasRegistry.registerAlias("LOG4J", Log4jImpl.class);
        this.typeAliasRegistry.registerAlias("LOG4J2", Log4j2Impl.class);
        // ...
    }

```

æ›´å¤šä¿¡æ¯å‚è€ƒä¸‹å›¾ï¼Œ

![](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/mybatis-builder1.png)



 æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. ` XMLConfigBuilder` å¤„ç†é…ç½®ç±» é›†ä¸­ç®¡ç†
2. `XMLMapperBuilder` å¤„ç† `xxxxMapper.xml` æ‰«æ xxxxMapper.xml ç­‰
3. `MapperBuilderAssistant` mapperè¾…åŠ©ç±»
4. `XMLStatementBuilder` statementç”Ÿæˆ
5. `XMLScriptBuilder` å¤„ç† xml ä¸­çš„ è„šæœ¬  
6. `SqlSourceBuilder` ç”Ÿæˆsql è¯­å¥
7. `ParameterMappingTokenHandler`  å°†å‚æ•° #{} æ›¿æ¢ä¸º ï¼Ÿï¼Œå¹¶ä¿å­˜å‚æ•°ä¿¡æ¯





### 2ã€æ•´ä½“æ‰§è¡Œæµç¨‹

![mybatisåŸºæœ¬æ‰§è¡Œæµç¨‹](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/mybatis1.png)





### 3ã€æŸ¥è¯¢è¯¦ç»†æ‰§è¡Œæµç¨‹





![è¯¦ç»†æ‰§è¡Œæµç¨‹](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/mybatis-detail1.png)










### 4ã€å…³äºå„ä¸ªå¤„ç†å™¨ï¼Œæ‰§è¡Œå™¨è¯´æ˜



#### 1ã€SqlSession



![](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/sqlsession.png)

ä¼šè¯ç®¡ç†ï¼Œé»˜è®¤æ˜¯ DefaultSqlSession





#### 2ã€Executor



![](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/executor1.png)



æ‰§è¡Œå™¨:

1. **CachingExecutor** 
   - äºŒçº§ç¼“å­˜
2. **BaseExecutor** ä¸€çº§ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰ä¸€çº§ç¼“å­˜ï¼Œæ‰§è¡Œæ•°æ®åº“æ“ä½œï¼Œå¦‚æœæ˜¯ä¿®æ”¹æ“ä½œï¼Œåˆ é™¤ç¼“å­˜
   - **SimpleExecutor**  ä¸€èˆ¬æŸ¥è¯¢æˆ–è€…ä¿®æ”¹å¤„ç†å™¨ 
   - **BatchExecutor** æ‰¹å¤„ç†









#### 3ã€StatementHandlder



![](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/hander.png)



**æ³¨æ„**

RoutingStatementHandler æœ€ç»ˆè¿˜æ˜¯ç”Ÿæˆ PreparedStatementHandler ã€SimpleStateHandler å’Œ

CallableStatementHandlerä¸‰ä¸ªä¸­çš„ä¸€ä¸ª







#### 4ã€ParameterHandlder





![](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/mybatis-paramter.png)



å‚æ•°è§£æï¼Œå°†ï¼Ÿæ›¿æ¢ä¸ºè¾“å…¥çš„å‚æ•°ï¼Œç„¶åé€šè¿‡ Preparement æ‰§è¡Œexqute() æ‰§è¡Œæ“ä½œ








## ä¸‰ ã€ç¼“å­˜





###  1ã€äºŒçº§ç¼“å­˜



æ³¨æ„äºŒçº§ç¼“å­˜æ‰§è¡Œåœ¨ä¸€çº§ç¼“å­˜ä¹‹å‰


äºŒçº§ç¼“å­˜å®ç°ç±»æ˜¯ `org.apache.ibatis.executor.CachingExecutor`


äºŒçº§ç¼“å­˜ä»¥å®ç°æ ¸å¿ƒéƒ¨åˆ†

```java
public class CachingExecutor implements Executor {
    private final Executor delegate;
    private final TransactionalCacheManager tcm = new TransactionalCacheManager();

    public CachingExecutor(Executor delegate) {
        this.delegate = delegate;
        delegate.setExecutorWrapper(this);
    }

    // ....

    public <E> List<E> query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
        Cache cache = ms.getCache();
        // è·å– mapper çš„äºŒçº§ç¼“å­˜
        if (cache != null) {
                // ...
                // è·å–å†…å®¹
                List<E> list = (List)this.tcm.getObject(cache, key);
                if (list == null) {
                    // å¦‚æœç»“æœä¸ºç©ºï¼Œä»æ‰§è¡Œå™¨ä¸­è·å– ä¸€èˆ¬æ˜¯ BaseExecutor
                    list = this.delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
                    this.tcm.putObject(cache, key, list);
                }
 		// å¦‚æœè·å–åˆ°å†…å®¹ç›´æ¥è¿”å›
                return list;

        }
        // å¦‚æœæ²¡æœ‰è·å–åˆ°å†…å®¹ äº¤ç»™ä¸‹ä¸€ä¸ªæ‰§è¡Œå™¨æ‰§è¡Œ ä¸€èˆ¬æ˜¯ BaseExecutor è´£ä»»é“¾æ¨¡å¼
        return this.delegate.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
    }

   // ....
}

```





###  2ã€ä¸€çº§ç¼“å­˜


`PerpetualCache ` ç»§æ‰¿äº† `cache` å¹¶ä¸”ä½œä¸º ä¸€çº§ç¼“å­˜ï¼Œå­˜å‚¨æ–¹å¼æ˜¯ `HashMap`

```java
    public <E> List<E> query(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
       // ....
         try {
                ++this.queryStack;
                // ä¸€çº§ç¼“å­˜
                list = resultHandler == null ? (List)this.localCache.getObject(key) : null;
                if (list != null) {
                    // ç¼“å­˜æ ¡éªŒ
                    this.handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);
                } else {
                    // ä»æ•°æ®åº“ä¸­è·å–
                    list = this.queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);
                }
            } finally {
                --this.queryStack;
            }
            // ...
            return list;
        }
    }

```



### 3ã€ç¼“å­˜ key æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ




```java
public <E> List<E> query(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler) throws SQLException {
        BoundSql boundSql = ms.getBoundSql(parameterObject);
        CacheKey key = this.createCacheKey(ms, parameterObject, rowBounds, boundSql);
        // èµ°ç¼“å­˜
        return this.query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);
  }
```


æ·»åŠ  cachekey

```java
    public CacheKey createCacheKey(MappedStatement ms, Object parameterObject, RowBounds rowBounds, BoundSql boundSql) {
        if (this.closed) {
            throw new ExecutorException("Executor was closed.");
        } else {
            CacheKey cacheKey = new CacheKey();
            cacheKey.update(ms.getId());
            cacheKey.update(rowBounds.getOffset());
            cacheKey.update(rowBounds.getLimit());
            cacheKey.update(boundSql.getSql());
            // ....
            return cacheKey;
        }
    }

```

é»˜è®¤`org.apache.ibatis.cache.CacheKey`é‡å†™äº†`toString`

```java
public String toString() {
        StringJoiner returnValue = new StringJoiner(":");
        returnValue.add(String.valueOf(this.hashcode));
        returnValue.add(String.valueOf(this.checksum));
        Stream var10000 = this.updateList.stream().map(ArrayUtil::toString);
        Objects.requireNonNull(returnValue);
        // lambdaè¡¨è¾¾å¼ æ‰§è¡Œ StringJoiner.add()
        // toString() æ‹¼è£…ä¹‹åè¿”å›
        // StringJoiner add å®é™…ä¸Šæ‰§è¡Œçš„æ˜¯ StringBuilder.append(xxxx)
        var10000.forEach(returnValue::add); 
        return returnValue.toString();
    }


// ...



```



å…³äºidçš„éƒ¨åˆ†æºä»£ç 

`org.apache.ibatis.binding.MapperMetho$SqlCommand`

```java
 private MappedStatement resolveMappedStatement(Class<?> mapperInterface, String methodName, Class<?> declaringClass, Configuration configuration) {
       String statementId = mapperInterface.getName() + "." + methodName;
             // ....
 }

```


ä¾‹å¦‚:

![](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/mp-idã€.png)â€‹



**å®ä¾‹key**

```txt
-8238651:-329230814:com.wuxin.mybatis.read.mapper.UserMapper.list:0:2147483647:select * from user;:development
```

* `MappedStatement`

  * id ï¼Œä¸º namespace + idName, å®é™…ä¸Šå°±æ˜¯mapperçš„å‘½åç©ºé—´å’Œ idå 
  *  ä¾‹å¦‚ `com.wuxin.mybatis.read.mapper.UserMapper`+`list`
* `Object`
* `RowBounds` åˆ†é¡µå¯¹è±¡
* é»˜è®¤ä¸º `RowBounds.DEFAULT`
* `ResultHandler` ç»“æœå¤„ç†å™¨
* é»˜è®¤ä¸º `Executor.NO_RESULT_HANDLER`







### 4ã€ä¿®æ”¹å’ŒæŸ¥è¯¢

- æŸ¥è¯¢
  - æ‰§è¡Œ executor ä¸­ **doQuery()**
- ä¿®æ”¹
  - æ·»åŠ 
  - åˆ é™¤
  - ä¿®æ”¹
  - æ‰§è¡Œ executor ä¸­ **doUpdate()**





**æŸ¥è¯¢**

å¦‚æœèµ°åˆ°è¿™ä¸€æ­¥äº†è¯´æ˜ç¼“å­˜ä¸­æ²¡æœ‰ç»“æœ

```java
   // org.apache.ibatis.executor.BaseExecutor

private <E> List<E> queryFromDatabase(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql) throws SQLException {
        
        this.localCache.putObject(key, ExecutionPlaceholder.EXECUTION_PLACEHOLDER);

        List list;
        try {
            // ä»æ•°æ®åº“ä¸­æ‰§è¡ŒæŸ¥è¯¢æ“ä½œ
            // è¯¥æ–¹æ³•åœ¨ BaseExecutorä¸ºæŠ½è±¡æ–¹æ³• ï¼Œäº¤ç»™å®ç°ç±»æ‰§è¡Œï¼ˆå››ç§ï¼‰å¦‚ä¸‹å›¾
            list = this.doQuery(ms, parameter, rowBounds, resultHandler, boundSql);
        } finally {
            // åˆ é™¤ä¹‹å‰å¯¹åº”çš„key
            this.localCache.removeObject(key);
        }
        // å­˜å…¥ ç¼“å­˜ä¸­
        this.localCache.putObject(key, list);
        // ...
        return list;
    }

```



äº¤ç»™ä¸‹ä¸€ä¸ªæ‰§è¡Œå™¨æ‰§è¡Œ

![](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/mybatis-select.png)



æœ€ç»ˆæ‰§è¡Œçš„æ˜¯

```java
  
// å¤„ç†å¤šä¸ªç»“æœ
public <E> List<E> query(Statement statement, ResultHandler resultHandler) throws SQLException {
        PreparedStatement ps = (PreparedStatement)statement;
        ps.execute();
        return this.resultSetHandler.handleResultSets(ps);
    }

// å¤„ç†å•ä¸ªç»“æœ
public <E> Cursor<E> queryCursor(Statement statement) throws SQLException {
        PreparedStatement ps = (PreparedStatement)statement;
        ps.execute();
        return this.resultSetHandler.handleCursorResultSets(ps);
    }
```









**ä¿®æ”¹** 

ä¿®æ”¹åŒ…æ‹¬æ·»åŠ ã€åˆ é™¤å’Œä¿®æ”¹æ“ä½œ

```java
 // org.apache.ibatis.executor.BaseExecutor
public int update(MappedStatement ms, Object parameter) throws SQLException {
      // ...
      // æ¯æ¬¡æ‰§è¡Œä¿®æ”¹æ“ä½œä¹‹å‰ï¼Œåˆ é™¤æœ¬åœ°ç¼“å­˜
     this.clearLocalCache();
     return this.doUpdate(ms, parameter);
 }
```



ä¿®æ”¹æ“ä½œæœ€ç»ˆæ‰§è¡Œçš„æ˜¯ `PreparedStatementHandler` çš„ update() æ–¹æ³•

```java
  public int update(Statement statement) throws SQLException {
        PreparedStatement ps = (PreparedStatement)statement;
        ps.execute();
        int rows = ps.getUpdateCount();
        // ...
        return rows;
    }

```











## å››ã€æ’ä»¶å®ç°



é»˜è®¤æŸ¥è¯¢åˆ†é¡µçš„ç»è¿‡ `DefaultSqlSession`æ–¹æ³• åˆ†é¡µè®¾ç½®é»˜è®¤å‚æ•° `RowBounds.DEFAULT`

```java

    public <E> List<E> selectList(String statement, Object parameter) {
        // å¦‚æœæ²¡æœ‰ RowBounds å¯¹è±¡ï¼Œç³»ç»Ÿé»˜è®¤ RowBounds.DEFAULT
        // RowBounds.DEFAULT ======>  offset=0 ï¼Œlimit= Integer.MAX_VALUE
        return this.selectList(statement, parameter, RowBounds.DEFAULT); //
    }

    public <E> List<E> selectList(String statement, Object parameter, RowBounds rowBounds) {
        return this.selectList(statement, parameter, rowBounds, Executor.NO_RESULT_HANDLER);
    }
```

æœ‰å…³ `RowBounds ` 

```java
Public class RowBounds {
    public static final int NO_ROW_OFFSET = 0;
    public static final int NO_ROW_LIMIT = Integer.MAX_VALUE;
    public static final RowBounds DEFAULT = new RowBounds(); 
    private final int offset;
    private final int limit;

    public RowBounds() {
        this.offset = 0;
        this.limit = Integer.MAX_VALUE;
    }
    public RowBounds(int offset, int limit) {
        this.offset = offset;
        this.limit = limit;
    }
    // .... getter methods
}
```

æ‰€ä»¥list æœ€å¤šèƒ½å¤ŸæŸ¥è¯¢ç»“æœ `Integer.MAX_VALUE`ï¼Œç»è¿‡æ‹¼æ¥ çš„sqlè¯­å¥

```sql
select c1,c2,...,cn from tbName xxxxx limit 0,Integer.MAX_VALUE
```



æ›´å¤šè¯¦æƒ…å‚è€ƒ ï¼šhttps://mybatis.net.cn/configuration.html#plugins

### 







## äº”ã€SQLç”Ÿæˆ





### 1ã€æ¡ä»¶å¤„ç†



mybatis ä¸­ å°è£…äº†è®¸å¤šå¯¹åº” mapperä¸­å„ç§å„æ ·çš„æ¡ä»¶



![](https://cdn.jsdelivr.net/gh/wuxin0011/blog-resource@main/picgo/sql1.png)





æ ¸å¿ƒ SqlNodeæ˜¯ TrimSqlNode

```java
public class TrimSqlNode implements SqlNode {
    // ...
}
```







### 2ã€"#{ }"æ˜¯å¦‚ä½• æ›¿æ¢æˆ "?"

é€šè¿‡ `GenericTokenParser` çš„æ–¹æ³• parse() 



```java
    public String parse(String text) {
       // ...
        do {
            // ...
            // å…³é”®æ›¿æ¢
            // å‚è€ƒä¸‹é¢æ­¥éª¤ SqlSourceBuilder ç±» çš„  ParameterMappingTokenHandler
            builder.append(this.handler.handleToken(expression.toString()))
        } while(start > -1);
        // ...
        return builder.toString();
    }

```

å¾ªç¯æŸ¥æ‰¾`#{`  å’Œ `}` é€šè¿‡ å­—ç¬¦ä¸²length æ–¹æ³•æ‰¾åˆ°åç§»é‡







`GenericTokenParser`  å¯¹è±¡æ˜¯é€šè¿‡ `SqlSourceBuilder` æ„é€ å‡½æ•°ç”Ÿæˆçš„

æ ¸å¿ƒéƒ¨åˆ†å¦‚ä¸‹

```java
    public SqlSource parse(/*...*/) {
        ParameterMappingTokenHandler handler = new ParameterMappingTokenHandler(this.configuration, parameterType, additionalParameters);
        GenericTokenParser parser = new GenericTokenParser("#{", "}", handler);
        String sql;
        // è¯¥è¿‡ç¨‹ å°†#{}æ›¿æ¢ä¸º ?
        if (this.configuration.isShrinkWhitespacesInSql()) {
            sql = parser.parse(removeExtraWhitespaces(originalSql));
        } else {
            sql = parser.parse(originalSql);
        }
        return new StaticSqlSource(this.configuration, sql, handler.getParameterMappings());
    }


// ParameterMappingTokenHandler ç±»æ˜¯ `SqlSourceBuilder` ç±»çš„ä¸€ä¸ªå†…éƒ¨ç±»
// ç”Ÿæˆ "?"
//
 private final List<ParameterMapping> parameterMappings = new ArrayList();
 public String handleToken(String content) {
     // ä¿å­˜ å‚æ•° åç§° æ¯”å¦‚ #{username} æ›¿æ¢ä¸º ? ï¼Œä½†æ˜¯å°† username ä¿å­˜åˆ°
     this.parameterMappings.add(this.buildParameterMapping(content));
     return "?";
 }

```





## å…­ã€mybaitsä¸­çš„è®¾è®¡æ¨¡å¼

1. å·¥å‚æ¨¡å¼
   - mybatisçš„ä¼šè¯æ˜¯é€šè¿‡ä¼šè¯å·¥å‚åˆ›å»ºã€‚ `SqlSessionFactory`ã€`ObjectFactory` ã€`MapperProxyFactory`
   -  ä¸€èˆ¬æƒ…å†µä¸‹å¦‚æœä¸æŒ‡å®šä¼šè¯ï¼Œç³»ç»Ÿè°ƒç”¨çš„æ˜¯é»˜è®¤çš„ `SqlSessionFactory`


2. å»ºé€ è€…æ¨¡å¼
   - è¿™ä¸ªå°±ä¸å¤šä»‹ç»äº†ï¼Œå¸¸è§çš„ xxxBuilderç±»éƒ½æ˜¯å»ºé€ è€…æ¨¡å¼ã€‚


3. ä»£ç†æ¨¡å¼ã€‚
   - mybatisä¸­æœ‰ `cglib` å’Œ `jdk`è‡ªå¸¦çš„ä»£ç†å·¥å…· `Reflect`ç±»å®ç°ã€‚
   - å…³äº `ä»£ç†æ¨¡å¼`ã€`è£…é¥°è€…æ¨¡å¼`å’Œ `é€‚é…å™¨æ¨¡å¼` ä¹‹é—´åŒºåˆ«å¯ç™¾åº¦,è¿™é‡Œç®€å•è¯´ä¸‹
      - ä»£ç†æ¨¡å¼: è¡¥å……åŠŸèƒ½çš„åŒæ—¶ï¼Œæ›´å¤šæ˜¯ä¸ºäº†å¢åŠ è®¿é—®æ§åˆ¶æƒé™
      - é€‚é…å™¨æ¨¡å¼: æ›´å¤šæ˜¯ä¸ºäº†å…¼å®¹æ€§ï¼ŒåŒä¸€ä¸ªæ¥å£æ–¹æ³•ä½¿ç”¨å¤šç§åŠŸèƒ½
      - è£…é¥°å™¨æ¨¡å¼ï¼šåœ¨åŸæ¥åŸºç¡€åŠŸèƒ½ä¸Šæ·»åŠ ä¸€äº›åŠŸèƒ½ã€‚
   
4. é€‚é…å™¨æ¨¡å¼
    - æ—¥å¿—åŠŸèƒ½å®ç°

5. è£…é¥°è€…æ¨¡å¼ 
   - ä¾‹å¦‚CacheåŒ…ä¸­çš„cache.decoratorså­åŒ…ä¸­ç­‰å„ä¸ªè£…é¥°è€…çš„å®ç°


6. ç­–ç•¥æ¨¡å¼
   - æ‰§è¡Œ `sqlNode`ï¼Œ å†³å®šä½¿ç”¨å“ªä¸ª `sqlNode` å™¨æ‰§è¡Œè¿‡ç¨‹
   - æ‰§è¡Œ `BaseExecutor`,mybatisä¸­æœ‰ä¸ªå››ä¸ªç±»ç»§æ‰¿äº†ï¼ˆå…·ä½“å¯çœ‹ä¸Šé¢å…³ç³»å›¾ï¼‰ `BaseExecutor` å¦‚æœæ²¡æœ‰æŒ‡å®šè¯ï¼Œæœ‰ä¸€ä¸ªé»˜è®¤çš„å…œåº•ã€‚


7. å•ä¾‹æ¨¡å¼ 
   - `ErrorContext`
   - `LogFactory` ï¼ŒPS ï¼š è¿™ä¸ªä¸æ˜¯å·¥å‚æ¨¡å¼ ğŸ¤£

8. è¿­ä»£å™¨æ¨¡å¼
   - å°† `#{}` æ›¿æ¢ä¸º `?`è¿‡ç¨‹å°±æ˜¯ç”¨äº†è¿­ä»£å™¨æ¨¡å¼ï¼Œå…·ä½“ç»†èŠ‚å‚è€ƒ `GenericTokenParser`
