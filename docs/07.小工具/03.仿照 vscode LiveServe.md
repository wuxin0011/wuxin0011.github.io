---
title: ä»¿ç…§ vscode LiveServe
date: 2023-06-11 18:52:40
permalink: /tools/node-live-serve/
sidebar: auto
categories:
  - å·¥å…·
tags:
  - node
author:
  name: wuxin0011
  link: https://github.com/wuxin0011
---







## å‰è¨€



**æ‘˜è¦**

ä½¿ç”¨è¿‡ `vite` çš„ ä½¬ä»¬ï¼Œéƒ½çŸ¥é“ï¼Œæ‰“åŒ…å®Œæ¯•ä¹‹å vite ä¼šæœ‰ä¸€ä¸ªé¢„è§ˆåŠŸèƒ½ï¼Œ`vite preview` å°±å¯ä»¥é¢„è§ˆæ‰“åŒ…åæ–‡ä»¶

vscode æ’ä»¶å¸‚åœºä¸­ä¹Ÿæœ‰ä¸€ä¸ªç±»ä¼¼æ’ä»¶ï¼Œå…¶å®åŠŸèƒ½éƒ½æ˜¯å¤§å·®ä¸å·®çš„

é„™äººæœ€è¿‘å­¦äº†ä¼š `nodejs` æˆ–è€…è¯´å¤ä¹ ä¸‹ï¼Œä»¥å‰çœ‹è¿‡ ,ä½†æ˜¯`api ` è°ƒç”¨å¤§å¸ˆè®°ä¸ä½ `api`ï¼Œä½†æ˜¯è®°ä¸ä½ `api`,æ²¡åŠæ³•ç”¨çš„å°‘

æƒ³ä½¿ç”¨ node åŸç”Ÿå®ç°ä¸€ä¸ªç±»ä¼¼åŠŸèƒ½ ï¼ˆå½“ç„¶æ˜¯ç®€é™‹ç‰ˆæœ¬ï¼‰ğŸ˜‚ï¼Œå…¶å®æ˜¯è›‹ç–¼ï¼Œä¸»è¦è¿˜æ˜¯æƒ³å›é¡¾ä¸‹ nodeï¼Œçœ‹äº†æ–‡æ¡£

æ„Ÿè§‰åˆä¼šäº†ï¼Œä½†æ˜¯å†™ä¸å‡ºå•¥ä¸œè¥¿ ğŸ˜‚



**å®ç°åŸç†**

å…·ä½“åŸç†åº”è¯¥æ˜¯ä¸éš¾ï¼Œå°±æ˜¯ ä½¿ç”¨`socket` ï¼Œè®¿é—®å¯¹åº”è·¯å¾„ï¼Œæˆ–è€…è¯´è¯·æ±‚å¯¹åº”çš„è·¯å¾„æ—¶å€™ï¼Œè¯»å–æœåŠ¡å™¨èµ„æºï¼Œè¿”å›

å…¶å®å°±æ˜¯ `Content-type`.ä¸è¿‡è¿™ä¸ªè¿‡ç¨‹å¦‚æœè‡ªå·±å®ç°ï¼Œè¿˜æ˜¯æ¯”è¾ƒéº»çƒ¦ï¼Œå¥½åœ¨ï¼Œäººæ€§åŒ– node ä¸­ `http` æ¨¡å—éå¸¸å¥½

ç”¨ï¼Œçœç•¥äº†å¾ˆå¤šæ­¥éª¤ ğŸ¤£ã€‚

å…¶ä»–æ²¡å•¥å¥½è¯´çš„äº†ï¼Œçœ‹ä¸‹é¢ æ–‡ä»¶ åº”è¯¥èƒ½çœ‹æ‡‚ï¼Œé„™äººè¯•è¿‡äº† è¿˜æœ‰äº› bug ï¼Œæ¯”å¦‚æœ‰äº›æ–‡ä»¶è¯»å–åˆ°äº†ï¼Œä½†æ˜¯æ²¡æœ‰è¿½åŠ 

åˆ°å±å¹•ä¸Šå»ã€‚





## ä»£ç 

### ä¸ä½¿ç”¨ç¼“å­˜

```js
const http = require('node:http')
const fs = require('node:fs')
const path = require('node:path')
const nodeURL = require('node:url')
const {
    exec
} = require('child_process');


const NotFound = `<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>404</title>
  <style>

  * {
    margin: 0;
    padding: 0;
  }

  html,body {
    height: 100vh;
    background:url("https://wuxin0011.github.io/fantasy/screen.png");
    background-size: cover;
    background-attachment: fixed;
    background-repeat: no-repeat;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  h2 {
    font-size:40px;
  }

</style>
</head>

<body>
  <h2>æœªçŸ¥é”™è¯¯</h2>
</body>

</html>
`


const Template = `<!DOCTYPE html>
  <html lang="en">
  
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>template</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
        height: 100vh;
        background-color: #eee;
      }
      .unknown-file::before {
        content: 'â“';
      }
      .folder::before,.file::before{
        content: 'ğŸ‘';
      }
      .html-file::before {
        content: 'ğŸ“˜';
      }
      .log-file::before,.json-file::before {
        content: 'ğŸ“„';
      }
      .apk-file::before {
        content: 'ğŸ“¦';
      }
      .css-file::before {
        content: 'ğŸŒ¼';
      }
      .js-file::before {
        content: 'ğŸŸ';
      }
      .ini-file::before,.config-file::before,.xml-file::before {
        content: 'ğŸ';
      }
      .js-file::before {
        content: 'ğŸ§';
      }
      .java-file::before{
        content: 'ğŸ‰';
      }
      .vue-file::before{
        content: 'ğŸ“€';
      }
      .ts-file::before{
        content: 'ğŸ“—';
      }
      .jsx-file::before{
        content: 'ğŸ‡';
      }
      .tsx-file::before{
        content: 'ğŸ§¿';
      }
      .iml-file::before{
        content: 'ğŸ—';
      }
      .class-file::before{
        content: 'ğŸ’';
      }
      .md-file::before{
         content: 'ğŸ“’';
      }

      .txt-file::before{
           content: 'ğŸ“„';
       }

      .jar-file::before,
      .docker-file::before,
      .exe-file::before,
      .run-file::before{
        content: 'ğŸš€';
      }

      .python-file::before{
        content: 'ğŸ¦';
      }

       .c-file::before{
        content: 'ğŸ›¢';
      }

      .r-file::before{
        content: 'ğŸ¥';
      }
     
      .rust-file::before{
        content: 'ğŸ”';
      }

      .ruby-file::before{
        content: 'ğŸ¿';
      }
     
       .go-file::before{
        content: 'ğŸ¥';
      }

      .php-file::before{
        content: 'ğŸ¥ª';
      }

      .kotlin-file::before{
        content: 'ğŸ§';
      }

      .matlab-file::before{
        content: 'ğŸ¥™';
      }
     .perl-file::before{
        content: 'ğŸ¿';
      }
       .lua-file::before{
        content: 'ğŸ§€';
      }
      .swift-file::before{
        content: 'ğŸ­';
      }
     
      .pdf-file::before {
        content: 'ğŸ“•';
      }
      .database-file::before {
        content: 'ğŸ‘”';
      }
       .compress-file::before {
        content: 'ğŸ¥…';
      }
      .link-file::before,
      .lnk-file::before,
      .ink-file::before,
      .gif-file::before{
        content: 'ğŸ”—';
      }
      .img-file::before {
        content: 'ğŸ”';
      }

      .doc-file::before ,
      .docx-file::before{
        content: 'ğŸ“';
      }
      .ppt-file::before , 
      .pptx-file::before{
        content: 'ğŸ§¨';
      }
      .xlsx-file::before , 
      .xls-file::before{
        content: 'ğŸ“Š';
      }
      .ttf-file::before , 
      .woff-file::before,
      .woff2-file::before{
        content: 'ğŸŒ°';
      }

      .ogg-file::before , 
      .mp3-file::before{
        content: 'ğŸ¥­';
      }
     
      a {
        text-decoration: none;
        cursor: pointer;
        color: #000;
        transition: all ease-in-out 0.3s;
      }
      a:hover {
        color: teal;
      }
      .container {
        display: flex;
        width: 75%;
        margin: 0 auto;
        margin-top: 100px;
        flex-wrap: wrap;
      }
      .container a {
        display: inline-block;
        margin: 10px;
        width: 200px;
        overflow:hidden;
        padding: 10px;
      }
    </style>
    
  </head>
  
  <body>
    <div class="container"></div>
  </body>
  </html>
  `

const isWindow = () => process.platform === 'win32'
const isMac = () => process.platform === 'darwin'
// è·å–æ–‡ä»¶åç¼€
const getExt = (urlString) => path.extname(nodeURL.parse(urlString).pathname)

// æ–‡ä»¶ç±»å‹åˆ¤æ–­
const isHTML = (file) => /\.html$/.test(file)
const isTxt = (file) => /\.(txt|log)/.test(file)
const isCss = (file) => /\.(css)$/.test(file)
const isJs = (file) => /\.(js)$/.test(file)
const isJsx = (file) => /\.(jsx)$/.test(file)
const isTs = (file) => /\.ts$/.test(file)
const isTsx = (file) => /\.(tsx)$/.test(file)
const isVue = (file) => /\.(vue)$/.test(file)
const isPython = (file) => /\.(py)$/.test(file)
const isRuby = (file) => /\.(rb)$/.test(file)
const isGo = (file) => /\.(go)$/.test(file)
const isRust = (file) => /\.(rs)$/.test(file)
const isSwift = (file) => /\.(swift)$/.test(file)
const isKotlin = (file) => /\.(kt)$/.test(file)
const isPhp = (file) => /\.(php)$/.test(file)
const isPerl = (file) => /\.(pl)$/.test(file)
const isMatlab = (file) => /\.(m)$/.test(file)
const isLua = (file) => /\.(lua)$/.test(file)
const isC = (file) => /\.(c|cpp|h|cc|cxx)$/.test(file)
const isR = (file) => /\.(r)$/.test(file)
const isClassFile = (file) => /\.(class)$/.test(file)
const isJavaFile = (file) => /\.(java)$/.test(file)
const isSQL = (file) => /\.(sql|bson|json|dump|bak|ldf|mdf|dmp|dat|idx)$/i.test(file)
const isApk = (file) => /\.(apk)$/i.test(file)
const isImage = (file) => /\.(png|jpg|jpeg|apng|avif|bmp|gif|ico|cur|svg|tiff|webp)$/.test(file)
const isLink = (file) => /\.(link|lnk|ink)$/.test(file)
const isCompress = (file) => /\.(zip|gz|tar|7z|rar|gzip|bzip|bzip2)$/i.test(file)
const isMd = (file) => /\.(md)$/.test(file)
const isRunFile = (file) => /\.(exe|sh|com|bat|msi|dll|bin|out|pl|jar)$/i.test(file)
const isConfigFile = (file) => /\.(ini|conf|cfg|rc|properties|plist|htaccess|cnf|yml|yaml|ddl)$/i.test(file)

// é’ˆå¯¹ä¸åŒè¯·æ±‚è¿”å›ä¸åŒæ ¼å¼
const getType = (url, is_html = false) => is_html ? 'text/html;charset=utf-8' : MEDIA_TYPE[getExt(url)] || `text/plain;charset=utf-8`

const getTagStr = (url, isFolder = false) => {
    const fileName = path.basename(url)
    if (isFolder) {
        return `<a class="folder" href="${url}">${fileName}</a>`
    } else {
        return `<a class="file ${getClassName(url)}" href="${url}" >${fileName}</a>`
    }

}

// å°† \ æˆ–è€… \\ æˆ–è€… // è½¬æ¢æˆ /
const getRequestUrl = (folderPath) => ("/" + folderPath.split(__dirname)[1].replace(/\\\\/ig, "/")).replace(/\\/ig, "/").replace(/\/\/\//g, "/").replace(/\/\//g, "/")


// æ–‡ä»¶åŒæ­¥è¯»å–
const readFile = (p, mode = 'utf-8') => {
    try {
        return fs.readFileSync(p)
    } catch (e) {
        errorLog(e)
        return ''
    }
}
const errorLog = (msg, log = "error.log",) => {
    msg = `\n=================${new Date()}==============\n ${msg} \n==============================================================================`
    fs.appendFile(path.join(__dirname, log), msg, (err) => {
        if (err) {
            console.warn('æ—¥å¿—å†™å…¥å¤±è´¥ï¼', err)
        }
    })
}

// æš‚æ—¶ä¸å¤„ç†icoæ ¼å¼æ–‡ä»¶
// åœ¨æ­¤å¤„å¯ä»¥é”™æ‹¦æˆªè¯·æ±‚ç®¡ç†
const isAllowResolve = (url) => {
    return !(url.indexOf('favicon.ico') !== -1) && !(url.startsWith('http://') || url.startsWith('https://'))
}


const MEDIA_TYPE = {
    '.jpg': 'image/jpeg',
    '.jpeg': 'image/jpeg',
    '.png': 'image/png',
    '.gif': 'image/gif',
    '.bmp': 'image/bmp',
    '.webp': 'image/webp',
    '.svg': 'image/svg+xml',
    '.csv': 'text/csv;charset=utf-8',
    '.html': 'text/html;charset=utf-8',
    '.txt': 'text/plain;charset=utf-8',
    '.log': 'text/plain;charset=utf-8',
    '.css': 'text/css;charset=utf-8',
    '.js': 'text/javascript;charset=utf-8',
    '.md': 'text/plain;charset=utf-8', // æš‚æ—¶å°†mdæ–‡ä»¶è®¾ç½®ä¸ºæµè§ˆå™¨å¯è¯»
    '.xml': 'application/xml',
    '.pdf': 'application/pdf',
    '.xlsx': 'application/vnd.ms-excel',
    '.xls': 'application/vnd.ms-excel',
    '.doc': 'application/msword',
    '.docx': 'application/msword',
    '.ppt': 'application/vnd.ms-powerpoint',
    '.pptx': 'application/vnd.ms-powerpoint',
    '.ttf': 'application/font-woff',
    '.woff': 'application/font-woff',
    '.woff2': 'application/font-woff',
    '.zip': 'application/zip',
    '.7z': 'application/zip',
    '.tar': 'application/zip',
    '.rar': 'application/zip',
    '.gzip': 'application/zip',
    '.bzip': 'application/zip',
    '.bzip2': 'application/zip',
    '.mp4': 'video/mp4',
    '.json': 'application/json',
    '.webm': 'video/webm',
    '.ogg': 'video/ogg',
    '.mp3': 'audio/mpeg',
    '.wav': 'audio/wav',
};


const getClassName = (url) => {

    if (isMd(url)) {
        return 'md-file'
    }
    if (isHTML(url)) {
        return 'html-file'
    }
    if (isMatlab(url)) {
        return 'matlab-file'
    }
    if (isPython(url)) {
        return 'python-file'
    }
    if (isR(url)) {
        return 'r-file'
    }
    if (isSwift(url)) {
        return 'swift-file'
    }
    if (isGo(url)) {
        return 'go-file'
    }
    if (isJs(url)) {
        return 'js-file'
    }
    if (isPerl(url)) {
        return 'pl-file'
    }
    if (isRust(url)) {
        return 'rust-file'
    }
    if (isRuby(url)) {
        return 'ruby-file'
    }
    if (isKotlin(url)) {
        return 'kotlin-file'
    }
    if (isPhp(url)) {
        return 'php-file'
    }
    if (isLua(url)) {
        return 'lua-file'
    }
    if (isC(url)) {
        return 'c-file'
    }
    if (isJsx(url)) {
        return 'jsx-file'
    }
    if (isTs(url)) {
        return 'ts-file'
    }
    if (isTsx(url)) {
        return 'tsx-file'
    }
    if (isVue(url)) {
        return 'vue-file'
    }
    if (isCss(url)) {
        return 'css-file'
    }
    if (isTxt(url)) {
        return 'txt-file'
    }
    if (isJavaFile(url)) {
        return 'java-file'
    }
    if (isClassFile(url)) {
        return 'class-file'
    }
    if (isConfigFile(url)) {
        return 'config-file'
    }
    if (isImage(url)) {
        return 'img-file'
    }
    if (isLink(url)) {
        return 'link-file'
    }
    if (isRunFile(url)) {
        return 'run-file'
    }
    if (isApk(url)) {
        return 'apk-file'
    }
    if (isSQL(url)) {
        return 'database-file'
    }
    if (isCompress(url)) {
        return 'compress-file'
    }
    return MEDIA_TYPE[getExt(url)] ? `${getExt(url).replace(/\./, '')}-file` : 'unknown-file'
}

// é¡µé¢
class Page {
    constructor(url, content, is_html = false) {
        this.pageUrl = url
        this.content = content
        this.contentType = getType(url, is_html)
    }
}


const NOT_FOUND_PAGE = new Page("404.html", NotFound, true)
const COMMAND_KEY = "COMMAND_KEY"
const hostname = '127.0.0.1'
let count = 0
/* command args */
let port = 8080
let isParseIndexHtml = false // æ˜¯å¦ç›´æ¥æ˜ å°„å½“å‰ç›®å½•ä¸­index.html å¯¹äºå•æ–‡ä»¶appåº”è¯¥æ˜¯å¯ç”¨è¿™ä¸ªå‚æ•°
let indexPage = 'index.html'
let isSingle = false // æ˜¯å¦æ˜¯å•æ–‡ä»¶
let refreshTime = 3000


/**
 * å¯åŠ¨å…¥å£
 */
const server = http.createServer((request, response) => {
    let req_url = decodeURIComponent(request.url)
    // æ˜¯å¦æ˜¯å…è®¸çš„è¯·æ±‚
    if (isAllowResolve(req_url)) {
        responseContent(request, response)
    }
})

const createIndexPage = (url) => `${isSingle ? __dirname : url}\\${indexPage}`

const hasExt = (url) => {
    return !!url && ((url.indexOf('.') !== -1) || url === '/')
}
/**
 * è¯·æ±‚çš„æ–‡ä»¶
 * @param {*} request è¯·æ±‚
 * @param {*} response å“åº”
 */
const responseContent = (request, response) => {

    let url = request.url
    if (url.indexOf('?') !== -1) {
        const arr = url.split('?')
        url = arr[0]
    }

    let real_url = path.join(__dirname, decodeURIComponent(url));
    let requestUrl = decodeURIComponent(url)
   
    if (!fs.existsSync(real_url)) {
        return;
    }


    try {
        const status = fs.statSync(real_url)
        // å¯¹äºæ²¡æœ‰åç¼€å¹¶ä¸”ä¸æ˜¯æ–‡ä»¶å¤¹çš„å†…å®¹ç›´æ¥ä¸å¤„ç†ï¼
        if (!hasExt(url)) {
            if (status.isDirectory() && isParseIndexHtml) {
                const indexHtml = createIndexPage(real_url)
                console.log('curReadFolder = >', indexHtml)
                if (fs.existsSync(indexHtml)) {
                    let content = readFile(indexHtml)
                    // å“åº”é¡µé¢å†…å®¹
                    const this_page = new Page(requestUrl, content, false)
                    responseTemplate(request, response, this_page)
                }
            }

            return;
        }
        if (status.isDirectory()) {
            // è¯»å–æ–‡ä»¶å¤¹å†…å®¹
            const content = curReadFolder(real_url)
            // å“åº”ä¸€ä¸ªç”Ÿæˆçš„é¡µé¢
            responseTemplate(request, response, new Page(requestUrl, content, true))
        } else {
            const content = readFile(real_url)
            // å“åº”é¡µé¢å†…å®¹
            const this_page = new Page(requestUrl, content, false)
            responseTemplate(request, response, this_page)
        }
    } catch (error) {
        responseErrorPage(request, response, error)
    }
}

/**
 * å“åº”ä¸€ä¸ªå¼‚å¸¸è¯·æ±‚çš„é¡µé¢
 * @param {*} request request
 * @param {*} response  response
 * @param {*} message é”™è¯¯è¯¦æƒ…
 * @param {*} template æŒ‡å®šé”™è¯¯æ¨¡æ¿
 * @param {*} url é”™è¯¯è¿æ¥ï¼Œé»˜è®¤æ˜¯ è¯·æ±‚åœ°å€
 */
const responseErrorPage = (request, response, message, template, url) => {
    let errorContent = null
    url = url ?? request.url
    template = template ?? NotFound
    if (message) {
        errorContent = template.replace(/<h2>(.*?)<\/h2>/, `<h2 style="color:red;">${message.toString()}<\/h2>`)
    }
    responseTemplate(request, response, new Page(url, message && errorContent ? errorContent : 'error', true))
}


/**
 * å“åº”å†…å®¹
 * @param {*} request è¯·æ±‚
 * @param {*} response å“åº”
 * @param {*} page pageç±»çš„å¯¹è±¡
 */
const responseTemplate = (request, response, page) => {
    try {
        response.setHeader('Content-Type', page.contentType);
        // !!! todo å¦‚æœç›´æ¥ä½¿ç”¨å†…å®¹é•¿çŸ­ä¸çŸ¥é“ä¸ºä»€ä¹ˆæŠ¥é”™ å®¹æ˜“ç¡®å®æ–‡ä»¶
        // response.setHeader('Content-length', page.content.length);
        response.write(page.content);
        response.end();
    } catch (error) {
        // ignore ...
    }
}


/**
 * å“åº”æ–‡ä»¶ä¸‹ç¬¬ä¸€å±‚æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ–‡ä»¶å’Œç›®å½•
 * @param {*} folderPath è·¯å¾„
 */
const curReadFolder = (folderPath = __dirname) => {
    let content = ''
    let reqUrl = folderPath === __dirname ? '/' : decodeURIComponent(getRequestUrl(folderPath))
    const indexHtml = createIndexPage(folderPath)
    console.log('curReadFolder = >', indexHtml)
    if (isParseIndexHtml && fs.existsSync(indexHtml)) {
        content = readFile(indexHtml)
    } else {
        let temp = ''
        // curr file
        const files = fs.readdirSync(folderPath)
        files.forEach((fileName) => {
            const filePath = path.join(folderPath, fileName);
            try {
                // file url => file content
                let this_url = getRequestUrl(filePath)
                let isDirectory = fs.statSync(filePath).isDirectory()
                temp += getTagStr(this_url, isDirectory)
            } catch (error) {
                errorLog(error)
                console.warn('stats error:', error)
            }
        });
        // create title ğŸ§µ
        let title = path.basename(reqUrl) === '/' || path.basename(reqUrl) === '' ? 'é¦–é¡µ' : path.basename(reqUrl)
        content = Template.replace(/<title>(.*?)<\/title>/, `<title>${title}</title>`).replace(/<div class="container">(.*?)<\/div>/, `<div class="container">${temp}</div>`)
    }
    return content
}

const openWebPage = (url = `http://${hostname}:${port}`) => {
    let command = ''
    let isInitSystemCommand = false
    if (!isInitSystemCommand) {
        if (isWindow()) {
            command = 'start'
            isInitSystemCommand = true
        } else if (isMac()) {
            command = 'open'
            isInitSystemCommand = true
        } else {
            // Linux ? or unknown platform
            isInitSystemCommand = false
        }
    }

    if (isInitSystemCommand) {
        exec(`${command} ${url}`, (error, stdout, stderr) => {
            if (error) {
                console.error(`æµè§ˆå™¨æ‰“å¼€å¤±è´¥ï¼é”™è¯¯è¯¦æƒ…: ${error}`);
                errorLog(error)
                return;
            }
            if (stderr) {
                console.error(`æµè§ˆå™¨æ‰“å¼€å¤±è´¥ï¼é”™è¯¯è¯¦æƒ…: ${stderr}`);
                errorLog(error)
                return;
            }
            console.log(`live-server å¯åŠ¨æˆåŠŸï¼ç‚¹å‡»è®¿é—® ${url}`)
        })
    } else {
        console.log(`å½“å‰ç¯å¢ƒä¸æ”¯æŒæ‰“å¼€é»˜è®¤æµè§ˆå™¨ è¯·æ‰‹åŠ¨æ‰“å¼€ï¼${url}`)
    }
}


class Command {
    constructor(index, indexPage, port, refresh) {
        this.index = !!index
        this.indexPage = indexPage
        this.port = isNaN(Number(port)) ? 8080 : Number(port)
        this.refresh = isNaN(Number(refresh)) ? 3000 : Number(refresh)
        // todo more command
    }
}

let commandObj = null


const runCommand = () => {
    if (includeCommand('--blog') || includeCommand('-b')) {
        openWebPage('https://wuxin0011.github.io/tools/node-live-serve/')
    } else if (includeCommand(help) || includeCommand('-h')) {
        helpCommand()
    } else {
        console.log(`\nuse node ${path.basename(__filename)} ${help} look more \n`)
        parseSingleParams()
        parseParseIndexHtmlParams()
        parseRefreshTimeParams()
        parsePortParams()
        run()
    }
}


const run = () => {
    /* init command ! */
    commandObj = new Command(isParseIndexHtml, indexPage, port, refreshTime)
    // run
    const start = (error) => {
        if (count < 20) {
            try {
                server.listen({
                    host: hostname,
                    port: port
                }, () => {
                    curReadFolder()
                    openWebPage()
                })
                server.on('error', (error) => {
                    console.error(`run fail ${error} `)
                    port += 1
                    count += 1
                    start(error)
                })
            } catch (error) {
                console.error(`run fail ${error} `)
                port += 1
                count += 1
                start(error)
            }

        } else {
            console.error('å¯åŠ¨å¤±è´¥:', error)
            server.close()
            errorLog(error)
        }
    }
    start()
}


const includeCommand = (arg) => {
    if (!arg) {
        return false
    }
    return process.argv.findIndex(param => param.indexOf(arg) !== -1) !== -1
}


const parseCommandArgs = (arg, defaultValue) => {
    if (defaultValue === undefined) {
        console.log('defaultValue is undefined')
        return undefined;
    }
    if (!arg) {
        console.log('args is null or undefined')
        return defaultValue
    }
    for (let i = 0; i < process.argv.length; i++) {
        const params = process.argv[i]
        if (params.indexOf(arg) !== -1) {
            if (params.indexOf('=') !== -1) {
                let s = params.split('=')
                return s[s.length - 1]
            } else {
                return defaultValue
            }
        }
    }
    return defaultValue
}


const help = '--help'
const parseIndexHtml = '--index'
const portCommand = '--port'
const refreshCommand = '--refresh'
const helpCommand = () => {
    console.log(`
  node ${path.basename(__filename)} [command] \n
  command list: \n
      command         description
      ===============================================================================================
      --help,-h       command Description
      --blog,-b       open blog url address https://wuxin0011.github.io/tools/node-live-serve/ 
      --port,-p       specify the startup port number default ${port}
      --index,-i      is it directly mapped to ${indexPage}? if it exists,you can directly index page  ,default ${isParseIndexHtml} ,use --index=index.html or -i=index.html 
      --single,-s     if your app is single app please use --single ,default ${isSingle} ,use -s or --single  
      --refresh,-r    content refresh time default ${refreshTime} 
  `)
}


const parseParseIndexHtmlParams = () => {
    if (includeCommand(parseIndexHtml)) {
        isParseIndexHtml = true
        indexPage = parseCommandArgs(parseIndexHtml, indexPage)
    } else if (includeCommand('-i')) {
        isParseIndexHtml = true
        indexPage = parseCommandArgs('-i', indexPage)
    }
}

const parseSingleParams = () => {
    if (includeCommand('--single') || includeCommand('-s')) {
        isSingle = true
        isParseIndexHtml = true
    }
}


const parseRefreshTimeParams = () => {
    if (includeCommand(refreshCommand) || includeCommand('-r')) {
        try {
            refreshTime = Number(parseCommandArgs(includeCommand('-r') ? '-r' : refreshCommand, 3000))
            if (isNaN(refreshTime)) {
                console.warn('refreshTime must be a number  use default 3000!')
                refreshTime = 3000
            }
            if (refreshTime < 16) {
                console.warn(`refreshTime ${refreshTime} not allow refreshTime min>=16,with use default 3000  `)
                refreshTime = 3000
            }
        } catch (error) {
            console.log(`${refreshCommand} command is parse fail ,${error}`)
            refreshTime = 3000
        }
    }
}
const parsePortParams = () => {
    if (includeCommand(portCommand) || includeCommand('-p')) {
        try {
            port = parseInt(parseCommandArgs(includeCommand('-p') ? '-p' : portCommand, port))
            if (port <= 1) {
                console.warn(`port ${port} not allow ,with use default `)
                port = 8080
            }
        } catch (error) {
            port = 8080
            console.log(`${portCommand} command is parse fail port default 8080! `)
        }
    }
}


const bootStrap = () => {
    runCommand()
}


/* run  */
bootStrap()

```



### ä½¿ç”¨ç¼“å­˜å¹¶ç›‘å¬å†…å®¹æ”¹å˜

```js
const http = require('node:http')
const fs = require('node:fs')
const path = require('node:path')
const nodeURL = require('node:url')
const {
    Worker,
    isMainThread,
    parentPort
} = require('worker_threads');
const {
    exec
} = require('child_process');


const NotFound = `<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>404</title>
  <style>

  * {
    margin: 0;
    padding: 0;
  }

  html,body {
    height: 100vh;
    background:url("https://wuxin0011.github.io/fantasy/screen.png");
    background-size: cover;
    background-attachment: fixed;
    background-repeat: no-repeat;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  h2 {
    font-size:40px;
  }

</style>
</head>

<body>
  <h2>æœªçŸ¥é”™è¯¯</h2>
</body>

</html>
`


const Template = `<!DOCTYPE html>
  <html lang="en">
  
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>template</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
        height: 100vh;
        background-color: #eee;
      }
      .unknown-file::before {
        content: 'â“';
      }
      .folder::before,.file::before{
        content: 'ğŸ‘';
      }
      .html-file::before {
        content: 'ğŸ“˜';
      }
      .log-file::before,.json-file::before {
        content: 'ğŸ“„';
      }
      .apk-file::before {
        content: 'ğŸ“¦';
      }
      .css-file::before {
        content: 'ğŸŒ¼';
      }
      .js-file::before {
        content: 'ğŸŸ';
      }
      .ini-file::before,.config-file::before,.xml-file::before {
        content: 'ğŸ';
      }
      .js-file::before {
        content: 'ğŸ§';
      }
      .java-file::before{
        content: 'ğŸ‰';
      }
      .vue-file::before{
        content: 'ğŸ“€';
      }
      .ts-file::before{
        content: 'ğŸ“—';
      }
      .jsx-file::before{
        content: 'ğŸ‡';
      }
      .tsx-file::before{
        content: 'ğŸ§¿';
      }
      .iml-file::before{
        content: 'ğŸ—';
      }
      .class-file::before{
        content: 'ğŸ’';
      }
      .md-file::before{
         content: 'ğŸ“’';
      }

      .txt-file::before{
           content: 'ğŸ“„';
       }

      .jar-file::before,
      .docker-file::before,
      .exe-file::before,
      .run-file::before{
        content: 'ğŸš€';
      }

      .python-file::before{
        content: 'ğŸ¦';
      }

       .c-file::before{
        content: 'ğŸ›¢';
      }

      .r-file::before{
        content: 'ğŸ¥';
      }
     
      .rust-file::before{
        content: 'ğŸ”';
      }

      .ruby-file::before{
        content: 'ğŸ¿';
      }
     
       .go-file::before{
        content: 'ğŸ¥';
      }

      .php-file::before{
        content: 'ğŸ¥ª';
      }

      .kotlin-file::before{
        content: 'ğŸ§';
      }

      .matlab-file::before{
        content: 'ğŸ¥™';
      }
     .perl-file::before{
        content: 'ğŸ¿';
      }
       .lua-file::before{
        content: 'ğŸ§€';
      }
      .swift-file::before{
        content: 'ğŸ­';
      }
     
      .pdf-file::before {
        content: 'ğŸ“•';
      }
      .database-file::before {
        content: 'ğŸ‘”';
      }
       .compress-file::before {
        content: 'ğŸ¥…';
      }
      .link-file::before,
      .lnk-file::before,
      .ink-file::before,
      .gif-file::before{
        content: 'ğŸ”—';
      }
      .img-file::before {
        content: 'ğŸ”';
      }

      .doc-file::before ,
      .docx-file::before{
        content: 'ğŸ“';
      }
      .ppt-file::before , 
      .pptx-file::before{
        content: 'ğŸ§¨';
      }
      .xlsx-file::before , 
      .xls-file::before{
        content: 'ğŸ“Š';
      }
      .ttf-file::before , 
      .woff-file::before,
      .woff2-file::before{
        content: 'ğŸŒ°';
      }

      .ogg-file::before , 
      .mp3-file::before{
        content: 'ğŸ¥­';
      }
     
      a {
        text-decoration: none;
        cursor: pointer;
        color: #000;
        transition: all ease-in-out 0.3s;
      }
      a:hover {
        color: teal;
      }
      .container {
        display: flex;
        width: 75%;
        margin: 0 auto;
        margin-top: 100px;
        flex-wrap: wrap;
      }
      .container a {
        display: inline-block;
        margin: 10px;
        width: 200px;
        overflow:hidden;
        padding: 10px;
      }
    </style>
    
  </head>
  
  <body>
    <div class="container"></div>
  </body>
  </html>
  `

const isWindow = () => process.platform === 'win32'
const isMac = () => process.platform === 'darwin'
// è·å–æ–‡ä»¶åç¼€
const getExt = (urlString) => path.extname(nodeURL.parse(urlString).pathname)

const createIndexPage = (url) => `${isSingle ? path.join(__dirname, directorFolder, indexPage) : `${url}//${indexPage}`}`

// æ–‡ä»¶ç±»å‹åˆ¤æ–­
const isHTML = (file) => /\.html$/.test(file)
const isTxt = (file) => /\.(txt|log)/.test(file)
const isCss = (file) => /\.(css)$/.test(file)
const isJs = (file) => /\.(js)$/.test(file)
const isJsx = (file) => /\.(jsx)$/.test(file)
const isTs = (file) => /\.ts$/.test(file)
const isTsx = (file) => /\.(tsx)$/.test(file)
const isVue = (file) => /\.(vue)$/.test(file)
const isPython = (file) => /\.(py)$/.test(file)
const isRuby = (file) => /\.(rb)$/.test(file)
const isGo = (file) => /\.(go)$/.test(file)
const isRust = (file) => /\.(rs)$/.test(file)
const isSwift = (file) => /\.(swift)$/.test(file)
const isKotlin = (file) => /\.(kt)$/.test(file)
const isPhp = (file) => /\.(php)$/.test(file)
const isPerl = (file) => /\.(pl)$/.test(file)
const isMatlab = (file) => /\.(m)$/.test(file)
const isLua = (file) => /\.(lua)$/.test(file)
const isC = (file) => /\.(c|cpp|h|cc|cxx)$/.test(file)
const isR = (file) => /\.(r)$/.test(file)
const isClassFile = (file) => /\.(class)$/.test(file)
const isJavaFile = (file) => /\.(java)$/.test(file)
const isSQL = (file) => /\.(sql|bson|json|dump|bak|ldf|mdf|dmp|dat|idx)$/i.test(file)
const isApk = (file) => /\.(apk)$/i.test(file)
const isImage = (file) => /\.(png|jpg|jpeg|apng|avif|bmp|gif|ico|cur|svg|tiff|webp)$/.test(file)
const isLink = (file) => /\.(link|lnk|ink)$/.test(file)
const isCompress = (file) => /\.(zip|gz|tar|7z|rar|gzip|bzip|bzip2)$/i.test(file)
const isMd = (file) => /\.(md)$/.test(file)
const isRunFile = (file) => /\.(exe|sh|com|bat|msi|dll|bin|out|pl|jar)$/i.test(file)
const isConfigFile = (file) => /\.(ini|conf|cfg|rc|properties|plist|htaccess|cnf|yml|yaml|ddl)$/i.test(file)

// é’ˆå¯¹ä¸åŒè¯·æ±‚è¿”å›ä¸åŒæ ¼å¼
const getType = (url, is_html = false) => is_html ? 'text/html;charset=utf-8' : MEDIA_TYPE[getExt(url)] || `text/plain;charset=utf-8`

const getTagStr = (url, isFolder = false) => {
    const fileName = path.basename(url)
    if (isFolder) {
        return `<a class="folder" href="${url}">${fileName}</a>`
    } else {
        return `<a class="file ${getClassName(url)}" href="${url}" >${fileName}</a>`
    }

}

// å°† \ æˆ–è€… \\ æˆ–è€… // è½¬æ¢æˆ /
const getRequestUrl = (folderPath) => {
    return ("/" + folderPath.split(path.join(__dirname, directorFolder))[1].replace(/\\\\/ig, "/")).replace(/\\/ig, "/").replace(/\/\/\//g, "/").replace(/\/\//g, "/")
}


// æ–‡ä»¶åŒæ­¥è¯»å–
const readFile = (p, mode = 'utf-8') => {
    try {
        if (!fs.existsSync(p)) {
            errorLog(`æ–‡ä»¶ä¸å­˜åœ¨ï¼${p}`)
            return ''
        }
        return fs.readFileSync(p)
    } catch (e) {
        errorLog(e)
        return ''
    }
}
const errorLog = (msg, log = "error.log",) => {
    msg = `\n=================${new Date()}==============\n ${msg} \n==============================================================================`
    fs.appendFile(path.join(__dirname, directorFolder, log), msg, (err) => {
        if (err) {
            console.warn('æ—¥å¿—å†™å…¥å¤±è´¥ï¼', err)
        }
    })
}

// æš‚æ—¶ä¸å¤„ç†icoæ ¼å¼æ–‡ä»¶
// åœ¨æ­¤å¤„å¯ä»¥é”™æ‹¦æˆªè¯·æ±‚ç®¡ç†
const isAllowResolve = (url) => {
    return !(url.indexOf('favicon.ico') !== -1) && !(url.startsWith('http://') || url.startsWith('https://'))
}


const MEDIA_TYPE = {
    '.jpg': 'image/jpeg',
    '.jpeg': 'image/jpeg',
    '.png': 'image/png',
    '.gif': 'image/gif',
    '.bmp': 'image/bmp',
    '.webp': 'image/webp',
    '.svg': 'image/svg+xml',
    '.csv': 'text/csv;charset=utf-8',
    '.html': 'text/html;charset=utf-8',
    '.txt': 'text/plain;charset=utf-8',
    '.log': 'text/plain;charset=utf-8',
    '.css': 'text/css;charset=utf-8',
    '.js': 'text/javascript;charset=utf-8',
    '.md': 'text/plain;charset=utf-8', // æš‚æ—¶å°†mdæ–‡ä»¶è®¾ç½®ä¸ºæµè§ˆå™¨å¯è¯»
    '.xml': 'application/xml',
    '.pdf': 'application/pdf',
    '.xlsx': 'application/vnd.ms-excel',
    '.xls': 'application/vnd.ms-excel',
    '.doc': 'application/msword',
    '.docx': 'application/msword',
    '.ppt': 'application/vnd.ms-powerpoint',
    '.pptx': 'application/vnd.ms-powerpoint',
    '.ttf': 'application/font-woff',
    '.woff': 'application/font-woff',
    '.woff2': 'application/font-woff',
    '.zip': 'application/zip',
    '.7z': 'application/zip',
    '.tar': 'application/zip',
    '.rar': 'application/zip',
    '.gzip': 'application/zip',
    '.bzip': 'application/zip',
    '.bzip2': 'application/zip',
    '.mp4': 'video/mp4',
    '.json': 'application/json',
    '.webm': 'video/webm',
    '.ogg': 'video/ogg',
    '.mp3': 'audio/mpeg',
    '.wav': 'audio/wav',
};


const getClassName = (url) => {

    if (isMd(url)) {
        return 'md-file'
    }
    if (isHTML(url)) {
        return 'html-file'
    }
    if (isMatlab(url)) {
        return 'matlab-file'
    }
    if (isPython(url)) {
        return 'python-file'
    }
    if (isR(url)) {
        return 'r-file'
    }
    if (isSwift(url)) {
        return 'swift-file'
    }
    if (isGo(url)) {
        return 'go-file'
    }
    if (isJs(url)) {
        return 'js-file'
    }
    if (isPerl(url)) {
        return 'pl-file'
    }
    if (isRust(url)) {
        return 'rust-file'
    }
    if (isRuby(url)) {
        return 'ruby-file'
    }
    if (isKotlin(url)) {
        return 'kotlin-file'
    }
    if (isPhp(url)) {
        return 'php-file'
    }
    if (isLua(url)) {
        return 'lua-file'
    }
    if (isC(url)) {
        return 'c-file'
    }
    if (isJsx(url)) {
        return 'jsx-file'
    }
    if (isTs(url)) {
        return 'ts-file'
    }
    if (isTsx(url)) {
        return 'tsx-file'
    }
    if (isVue(url)) {
        return 'vue-file'
    }
    if (isCss(url)) {
        return 'css-file'
    }
    if (isTxt(url)) {
        return 'txt-file'
    }
    if (isJavaFile(url)) {
        return 'java-file'
    }
    if (isClassFile(url)) {
        return 'class-file'
    }
    if (isConfigFile(url)) {
        return 'config-file'
    }
    if (isImage(url)) {
        return 'img-file'
    }
    if (isLink(url)) {
        return 'link-file'
    }
    if (isRunFile(url)) {
        return 'run-file'
    }
    if (isApk(url)) {
        return 'apk-file'
    }
    if (isSQL(url)) {
        return 'database-file'
    }
    if (isCompress(url)) {
        return 'compress-file'
    }
    return MEDIA_TYPE[getExt(url)] ? `${getExt(url).replace(/\./, '')}-file` : 'unknown-file'
}

// é¡µé¢
class Page {
    constructor(url, content, is_html = false) {
        this.pageUrl = url
        this.content = content
        this.contentType = getType(url, is_html)
    }
}

// LRUç¼“å­˜
class LRUCache {
    constructor(capacity) {
        this.capacity = capacity;
        this.cache = new Map();
    }

    get(key) {
        if (this.cache.has(key)) {
            const value = this.cache.get(key);
            this.cache.delete(key);
            this.cache.set(key, value);
            return value;
        }
        return -1; // å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨æŒ‡å®šçš„é”®ï¼Œåˆ™è¿”å› -1
    }

    set(key, value) {
        if (this.cache.has(key)) {
            this.cache.delete(key);
        } else if (this.cache.size >= this.capacity) {
            const oldestKey = this.cache.keys().next().value;
            this.cache.delete(oldestKey);
        }
        this.cache.set(key, value);
    }

    remove(key) {
        if (this.cache.has(key)) {
            this.cache.delete(key);
        }
    }
}


const allReqUrl = []
const MAX_PAGE_SIZE = 100
const NotFoundPageUrl = []
const NOT_FOUND_PAGE = new Page("404.html", NotFound, true)
const COMMAND_KEY = "COMMAND_KEY"
const hostname = '127.0.0.1'
let count = 0
let pageCache = null
/* command args */
let port = 8080
let isParseIndexHtml = false // æ˜¯å¦ç›´æ¥æ˜ å°„å½“å‰ç›®å½•ä¸­index.html å¯¹äºå•æ–‡ä»¶appåº”è¯¥æ˜¯å¯ç”¨è¿™ä¸ªå‚æ•°
let indexPage = 'index.html'
let isSingle = false // æ˜¯å¦æ˜¯å•æ–‡ä»¶
let directorFolder = '.'
let refreshTime = 3000


/**
 * å¯åŠ¨å…¥å£
 */
const server = http.createServer((request, response) => {
    let req_url = decodeURIComponent(request.url)
    // æ˜¯å¦æ˜¯é”™è¯¯è¯·æ±‚
    if (NotFoundPageUrl.indexOf(request.url) !== -1) {
        responseTemplate(request, response, NOT_FOUND_PAGE)
        return;
    }
    // æ˜¯å¦æ˜¯å…è®¸çš„è¯·æ±‚
    if (isAllowResolve(req_url)) {
        // è¯·æ±‚æ˜¯å¦å­˜åœ¨ä»¥åŠæ˜¯å¦ç¼“å­˜äº†å¦‚æœè¯·æ±‚æ²¡æœ‰ç¼“å­˜èµ°è¯¥è¯·æ±‚
        if (allReqUrl.indexOf(req_url) === -1) {
            responseContent(request, response)
            return;
        }
        // å“åº”å¤„ç†
        const cacheContent = pageCache.get(req_url)
        if (cacheContent === -1) {
            responseContent(request, response)
            return;
        }
        responseTemplate(request, response, cacheContent ?? NOT_FOUND_PAGE)
    }
})


const hasExt = (url) => {
    return !!url && ((url.indexOf('.') !== -1) || url === '/')
}
/**
 * è¯·æ±‚çš„æ–‡ä»¶
 * @param {*} request è¯·æ±‚
 * @param {*} response å“åº”
 */
const responseContent = (request, response) => {

    let url = request.url
    const parsedUrl = nodeURL.parse(request.url, true);
    // è·å–URLä¸­çš„å“ˆå¸Œéƒ¨åˆ†
    // console.log('è¯·æ±‚è·¯å¾„',parsedUrl)
    if (url.indexOf('?') !== -1) {
        const arr = url.split('?')
        url = arr[0]
    }

    let real_url = path.join(__dirname, directorFolder, decodeURIComponent(url));
    let requestUrl = decodeURIComponent(url)
    try {
        const status = fs.statSync(real_url)
        // å¯¹äºæ²¡æœ‰åç¼€å¹¶ä¸”ä¸æ˜¯æ–‡ä»¶å¤¹çš„å†…å®¹ç›´æ¥ä¸å¤„ç†ï¼
        if (!hasExt(url)) {
            if (status.isDirectory() && isParseIndexHtml) {
                const indexHtml = createIndexPage(real_url)
                if (fs.existsSync(indexHtml)) {
                    let content = readFile(indexHtml)
                    // å“åº”é¡µé¢å†…å®¹
                    const this_page = new Page(requestUrl, content, false)
                    responseTemplate(request, response, this_page)
                    // ç¼“å­˜æœ¬æ¬¡ è¯·æ±‚
                    allReqUrl.push(requestUrl)
                    pageCache.set(requestUrl, this_page)
                }
            }

            return;
        }
        if (status.isDirectory()) {
            // è¯»å–æ–‡ä»¶å¤¹å†…å®¹
            curReadFolder(real_url)
            // å“åº”ä¸€ä¸ªç”Ÿæˆçš„é¡µé¢
            const page = pageCache.get(requestUrl)
            responseTemplate(request, response, page !== -1 ? page : NOT_FOUND_PAGE)
        } else {
            const content = readFile(real_url)
            if (!content) {
                if (!isSingle) {
                    responseErrorPage(request, response, "è¯·æ±‚å†…å®¹ä¸å­˜åœ¨")
                    // ç¼“å­˜æœ¬æ¬¡è¯·æ±‚
                    NotFoundPageUrl.push(requestUrl)
                }

            } else {
                // å“åº”é¡µé¢å†…å®¹
                const this_page = new Page(requestUrl, content, false)
                responseTemplate(request, response, this_page)
                // ç¼“å­˜æœ¬æ¬¡ è¯·æ±‚
                allReqUrl.push(requestUrl)
                pageCache.set(requestUrl, this_page)
            }
        }
    } catch (error) {
        if (!isSingle) {
            responseErrorPage(request, response, error)
        }
    }
}

/**
 * å“åº”ä¸€ä¸ªå¼‚å¸¸è¯·æ±‚çš„é¡µé¢
 * @param {*} request request
 * @param {*} response  response
 * @param {*} message é”™è¯¯è¯¦æƒ…
 * @param {*} template æŒ‡å®šé”™è¯¯æ¨¡æ¿
 * @param {*} url é”™è¯¯è¿æ¥ï¼Œé»˜è®¤æ˜¯ è¯·æ±‚åœ°å€
 */
const responseErrorPage = (request, response, message, template, url) => {
    let errorContent = null
    url = url ?? request.url
    template = template ?? NotFound
    if (message) {
        errorContent = template.replace(/<h2>(.*?)<\/h2>/, `<h2 style="color:red;">${message.toString()}<\/h2>`)
    }
    responseTemplate(request, response, new Page(url, message && errorContent ? errorContent : 'error', true))
}


/**
 * å“åº”å†…å®¹
 * @param {*} request è¯·æ±‚
 * @param {*} response å“åº”
 * @param {*} page pageç±»çš„å¯¹è±¡
 */
const responseTemplate = (request, response, page) => {
    try {
        response.setHeader('Content-Type', page.contentType);
        // !!! todo å¦‚æœç›´æ¥ä½¿ç”¨å†…å®¹é•¿çŸ­ä¸çŸ¥é“ä¸ºä»€ä¹ˆæŠ¥é”™ å®¹æ˜“ç¡®å®æ–‡ä»¶
        // response.setHeader('Content-length', page.content.length);
        response.write(page.content);
        response.end();
    } catch (error) {
        // ignore ...
    }
}


/**
 * å“åº”æ–‡ä»¶ä¸‹ç¬¬ä¸€å±‚æ–‡ä»¶ï¼ŒåŒ…æ‹¬æ–‡ä»¶å’Œç›®å½•
 * @param {*} folderPath è·¯å¾„
 * @param cache
 */
const curReadFolder = (folderPath, cache = pageCache) => {
    let content = ''
    let reqUrl = folderPath === path.join(__dirname, directorFolder) ? '/' : decodeURIComponent(getRequestUrl(folderPath))
    const indexHtml = createIndexPage(folderPath)
    if (isParseIndexHtml && fs.existsSync(indexHtml)) {
        content = readFile(indexHtml)
    } else {
        let temp = ''
        // curr file
        const files = fs.readdirSync(folderPath)
        files.forEach((fileName) => {
            const filePath = path.join(folderPath, fileName);
            try {
                // file url => file content
                let this_url = getRequestUrl(filePath)
                let isDirectory = fs.statSync(filePath).isDirectory()
                temp += getTagStr(this_url, isDirectory)
            } catch (error) {
                errorLog(error)
                console.warn('stats error:', error)
            }
        });
        // create title ğŸ§µ
        let title = path.basename(reqUrl) === '/' || path.basename(reqUrl) === '' ? 'é¦–é¡µ' : path.basename(reqUrl)
        content = Template.replace(/<title>(.*?)<\/title>/, `<title>${title}</title>`).replace(/<div class="container">(.*?)<\/div>/, `<div class="container">${temp}</div>`)
    }
    cache.set(reqUrl, new Page(reqUrl, content, true))
    allReqUrl.push(reqUrl)
    return content
}


/* child worker */
const watch = (message) => {
    if (message instanceof Map) {
        for (let [k, v] of message.entries()) {
            if (k === COMMAND_KEY) {
                // init child params!
                const command = message.get(COMMAND_KEY)
                isParseIndexHtml = command.index
                indexPage = command.indexPage
                directorFolder = command.directorFolder
                isSingle = command.single
                port = command.port
                refreshTime = command.refresh
            } else {
                watchFileChange(v, message)
            }
        }
        // update content notify parent !
        parentPort.postMessage(message);
    }

}


const watchFileChange = (page, cache) => {
    if (!(cache instanceof Map)) {
        return;
    }
    if (!page?.pageUrl || !page?.content || !page?.contentType) {
        return;
    }
    let pageUrl = page.pageUrl
    let real_url = path.join(__dirname, directorFolder, decodeURIComponent(pageUrl));
    if (!fs.existsSync(real_url)) {
        console.log('file or folder is not exist:', real_url)
        return;
    }
    const status = fs.statSync(real_url)

    if (status.isDirectory()) {
        curReadFolder(real_url, cache)
    } else {
        try {
            const data = readFile(real_url)
            if (data.toString() !== page.content.toString()) {
                cache.set(pageUrl, new Page(pageUrl, data))
            }
        } catch (error) {
            errorLog(error)
        }

    }


}


const openWebPage = (url = `http://${hostname}:${port}`) => {
    let command = ''
    let isInitSystemCommand = false
    if (!isInitSystemCommand) {
        if (isWindow()) {
            command = 'start'
            isInitSystemCommand = true
        } else if (isMac()) {
            command = 'open'
            isInitSystemCommand = true
        } else {
            // Linux ? or unknown platform
            isInitSystemCommand = false
        }
    }

    if (isInitSystemCommand) {
        exec(`${command} ${url}`, (error, stdout, stderr) => {
            if (error) {
                console.error(`æµè§ˆå™¨æ‰“å¼€å¤±è´¥ï¼é”™è¯¯è¯¦æƒ…: ${error}`);
                errorLog(error)
                return;
            }
            if (stderr) {
                console.error(`æµè§ˆå™¨æ‰“å¼€å¤±è´¥ï¼é”™è¯¯è¯¦æƒ…: ${stderr}`);
                errorLog(error)
                return;
            }
            console.log(`live-server å¯åŠ¨æˆåŠŸï¼ç‚¹å‡»è®¿é—® ${url}`)
        })
    } else {
        console.log(`å½“å‰ç¯å¢ƒä¸æ”¯æŒæ‰“å¼€é»˜è®¤æµè§ˆå™¨ è¯·æ‰‹åŠ¨æ‰“å¼€ï¼${url}`)
    }
}


const cacheUpdate = (message) => {
    if (!(message instanceof Map)) {
        return;
    }
    for (let [k, v] of message.entries()) {
        if (k !== COMMAND_KEY) {
            pageCache.set(k, v)
        }
    }
}


class Command {

    /**
     *
     * @param index æ˜¯å¦é»˜è®¤æ‰“å¼€ æŒ‡å®š é¡µ é»˜è®¤æ˜¯ index.html
     * @param indexPage é»˜è®¤é¡µ index.html
     * @param root é¡¹ç›®å¯åŠ¨æŒ‡å®šè·Ÿè·¯å¾„ é»˜è®¤ å½“å‰è·¯å¾„
     * @param single æ˜¯å¦å¼€å¯å•æ–‡ä»¶æ¨¡å¼
     * @param port ç«¯å£å·
     * @param refresh åˆ·æ–°æ—¶é—´é—´éš”
     */
    constructor(index, indexPage, root, single, port, refresh) {
        this.index = !!index
        this.indexPage = indexPage
        this.directorFolder = root
        this.single = single
        this.port = isNaN(Number(port)) ? 8080 : Number(port)
        this.refresh = isNaN(Number(refresh)) ? 3000 : Number(refresh)
        // todo more command
    }
}

let commandObj = null


const childWorkerRun = () => {
    const childWorker = new Worker(__filename);
    pageCache.cache.set(COMMAND_KEY, commandObj)
    setInterval(() => {
        childWorker.postMessage(pageCache.cache);
    }, refreshTime);
    childWorker.on('message', message => {
        cacheUpdate(message)
    });
}

const runCommand = () => {
    if (includeCommand('--blog') || includeCommand('-b')) {
        openWebPage('https://wuxin0011.github.io/tools/node-live-serve/')
    } else if (includeCommand(help) || includeCommand('-h')) {
        helpCommand()
    } else {
        console.log(`\nuse node ${path.basename(__filename)} ${help} look more \n`)
        parseParseIndexHtmlParams()
        parseSingleParams()
        parseRefreshTimeParams()
        parsePortParams()
        run()
    }
}


const run = () => {
    /* init command  */
    commandObj = new Command(isParseIndexHtml, indexPage, directorFolder, isSingle, port, refreshTime)
    /* init cache */
    pageCache = new LRUCache(MAX_PAGE_SIZE)

    // run
    const start = (error) => {
        if (count < 20) {
            try {
                server.listen({
                    host: hostname,
                    port: port
                }, () => {
                    curReadFolder(path.join(__dirname, directorFolder))
                    openWebPage()
                    childWorkerRun()
                })
                server.on('error', (error) => {
                    console.error(`run fail ${error} `)
                    port += 1
                    count += 1
                    start(error)
                })
            } catch (error) {
                console.error(`run fail ${error} `)
                port += 1
                count += 1
                start(error)
            }

        } else {
            console.error('å¯åŠ¨å¤±è´¥:', error)
            server.close()
            errorLog(error)
        }
    }
    start()
}


const includeCommand = (arg) => {
    if (!arg) {
        return false
    }
    return process.argv.findIndex(param => param.indexOf(arg) !== -1) !== -1
}


const parseCommandArgs = (arg, defaultValue) => {
    if (defaultValue === undefined) {
        console.log('defaultValue is undefined')
        return undefined;
    }
    if (!arg) {
        console.log('args is null or undefined')
        return defaultValue
    }
    for (let i = 0; i < process.argv.length; i++) {
        const params = process.argv[i]
        if (params.indexOf(arg) !== -1) {
            if (params.indexOf('=') !== -1) {
                let s = params.split('=')
                return s[s.length - 1]
            } else {
                return defaultValue
            }
        }
    }
    return defaultValue
}


const help = '--help'
const parseIndexHtml = '--index'
const portCommand = '--port'
const refreshCommand = '--time'
const helpCommand = () => {
    console.log(`
  node ${path.basename(__filename)} [command] \n
  command list: \n
      command         description
      ===============================================================================================
      --help,-h       command Description
      --blog,-b       open blog url address https://wuxin0011.github.io/tools/node-live-serve/ 
      --port,-p       specify the startup port number default ${port}
      --root,-r       directly root folder ,if you want dist to root folder , use --root=dist
      --index,-i      is it directly mapped to ${indexPage}? if it exists,you can directly index page  ,
                      default ${isParseIndexHtml} ,example --index=index.html or -i=index.html 
      --single,-s     if your app is single app please use --single,
                      use -s or --single
      --time,-t       content refresh time default ${refreshTime},example --time=3000  
  `)
}


const parseParseIndexHtmlParams = () => {
    if (includeCommand(parseIndexHtml)) {
        isParseIndexHtml = true
        indexPage = parseCommandArgs(parseIndexHtml, indexPage)
    } else if (includeCommand('-i')) {
        isParseIndexHtml = true
        indexPage = parseCommandArgs('-i', indexPage)
    }
}

const parseSingleParams = () => {

    if (includeCommand('--root') || includeCommand('-r')) {
        directorFolder = parseCommandArgs(includeCommand('--root') ? '--root' : '-r', directorFolder)
        // check file is exist ?
        const file = path.join(__dirname, directorFolder)
        if (!fs.existsSync(file)) {
            throw new Error(`${directorFolder} folder is not exist ,please check folder exist!, example --root=dist or -r=dist !`)
        }
    }
    if (includeCommand('--single') || includeCommand('-s')) {
        isSingle = true
        isParseIndexHtml = true
        // check file is exist ?
        const file = path.join(__dirname, directorFolder, indexPage)
        if (!fs.existsSync(file)) {
            throw new Error(`${file} is not exist ,please check file !`)
        }
    }
}


const parseRefreshTimeParams = () => {
    if (includeCommand(refreshCommand) || includeCommand('-t')) {
        try {
            refreshTime = Number(parseCommandArgs(includeCommand('-t') ? '-t' : refreshCommand, 3000))
            if (isNaN(refreshTime)) {
                console.warn('refreshTime must be a number  use default 3000!')
                refreshTime = 3000
            }
            if (refreshTime < 16) {
                console.warn(`refreshTime ${refreshTime} not allow refreshTime min>=16,with use default 3000  `)
                refreshTime = 3000
            }
        } catch (error) {
            console.log(`${refreshCommand} command is parse fail ,${error}`)
            refreshTime = 3000
        }
    }
}
const parsePortParams = () => {
    if (includeCommand(portCommand) || includeCommand('-p')) {
        try {
            port = parseInt(parseCommandArgs(includeCommand('-p') ? '-p' : portCommand, port))
            if (port <= 1) {
                console.warn(`port ${port} not allow ,with use default `)
                port = 8080
            }
        } catch (error) {
            port = 8080
            console.log(`${portCommand} command is parse fail port default 8080! `)
        }
    }
}


const bootStrap = () => {
    if (isMainThread) {
        runCommand()
    } else {
        parentPort.on('message', message => {
            watch(message)
        });
    }
}


/* run  */
bootStrap()

```





**ä½¿ç”¨**

æ‹·è´ä¸Šé¢ js æ–‡ä»¶,å¦‚ `server.js`

å¯åŠ¨

```shell
node server.js
```













## æ¼”ç¤ºæ•ˆæœ



![æ¼”ç¤ºæ•ˆæœ](https://user-images.githubusercontent.com/65836396/245029311-fab34522-90f3-4c54-ab3e-351d55a40983.gif)



## é—®é¢˜

 

**å­˜åœ¨é—®é¢˜**

- è‡ªåŠ¨ä¸‹è½½ä¸€äº›æ–‡ä»¶
- ç•Œé¢ä¸å¥½çœ‹



**å·²å¤„ç†**

- æ³¨é‡Šäº† `content-length` å­—æ®µä¹‹åï¼Œå†…å®¹æ˜¾ç¤ºæ­£å¸¸äº†

